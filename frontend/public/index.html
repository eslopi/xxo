<!DOCTYPE html>

<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      direction: rtl;
      background-color: #f4f4f4;
      color: #333;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      width: 100%;
      padding: 15px 20px;
      background-color: #f4f4f4;
      color: #333;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .container {
      display: flex;
      width: 100%;
      background-color: white;
      height: calc(100vh - 50px);
    }

    #map-container {
      width: 50%;
      position: relative;
      height: 100%;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    #locateButton {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1;
      background-color: #333;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #locateButton:hover {
      background-color: #222;
    }

    #info-container {
      width: 50%;
      padding: 20px;
      background-color: #f9f9f9;
      overflow-y: auto;
      height: 100%;
    }

    #place-info {
      display: none;
    }

    #place-info img {
      max-width: 100%;
      height: auto;
      border-radius: 5px;
    }

    .chat-button {
      margin-top: 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      font-size: 16px;
      background-color: #333;
      color: white;
    }

    .chat-button:hover {
      background-color: #222;
    }

    /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© */
    .popup-chat-container {
      display: none;
      position: fixed;
      right: 20px;
      bottom: 20px;
      width: 300px;
      height: 400px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      z-index: 2000;
      flex-direction: column;
    }

    .popup-chat-header {
      background-color: #333;
      color: white;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }

    .popup-chat-header h3 {
      margin: 0;
      font-size: 16px;
    }

    .popup-chat-header button {
      background-color: transparent;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    .popup-chat-body {
      flex-grow: 1;
      padding: 10px;
      overflow-y: auto;
    }

    .popup-chat-footer {
      padding: 10px;
      display: flex;
    }

    .popup-chat-footer input[type="text"] {
      flex-grow: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-right: 5px;
    }

    .popup-chat-footer button {
      padding: 8px;
      background-color: #0084ff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† Ø­Ø§Ù„ÙŠÙ‹Ø§ */
    .user-list {
      background-color: #f1f1f1;
      padding: 10px;
      max-height: 100px;
      overflow-y: auto;
      border-top: 1px solid #ccc;
    }

    .user-list ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }

    .user-list li {
      padding: 5px;
      background-color: #fff;
      margin-bottom: 5px;
      border-radius: 5px;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
  <div class="header">
    <h1>MS|MV</h1>
    <h3>Ø§ÙƒØªØ´Ù - ØªÙØ§Ø¹Ù„ - Ø´Ø§Ø±Ùƒ</h3>
  </div>

  <!-- Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
  <div class="container">
    <div id="map-container">
      <button id="locateButton">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
      <div id="map"></div>
    </div>

    <div id="info-container">
      <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ù…Ø§ÙƒÙ†</h2>
      <div id="place-info">
        <h3 id="place-name"></h3>
        <p id="place-description"></p>
        <img id="place-image" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒØ§Ù†">
        <button id="botChat" class="chat-button" onclick="openBotChat()">ğŸ›  MS|MV Ù…Ø³Ø§Ø¹Ø¯ Ø¨ÙˆØª</button>
        <button id="liveChat" class="chat-button" onclick="openLiveChat()">ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ø­ÙŠØ© Ù…Ø¹ Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ†</button>
      </div>
      <p id="no-selection">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£Ø­Ø¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª.</p>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
  <div id="botChatPopup" class="popup-chat-container">
    <div class="popup-chat-header">
      <h3>Ù…Ø³Ø§Ø¹Ø¯ Ø¨ÙˆØª</h3>
      <button onclick="closeBotChat()">âœ–</button>
    </div>
    <div class="popup-chat-body" id="botChatMessages">
      <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù‡Ù†Ø§ -->
    </div>
    <div class="popup-chat-footer">
      <input type="text" id="botChatInput" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." />
      <button onclick="sendBotChatMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø­ÙŠØ© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
  <div id="liveChatPopup" class="popup-chat-container">
    <div class="popup-chat-header">
      <h3>Ø¯Ø±Ø¯Ø´Ø© Ø­ÙŠØ©</h3>
      <button onclick="closeLiveChat()">âœ–</button>
    </div>
    <div class="popup-chat-body" id="liveChatMessages">
      <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù‡Ù†Ø§ -->
    </div>
    <div class="user-list">
      <h4>Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø­Ø§Ù„ÙŠÙ‹Ø§:</h4>
      <ul id="liveUserList">
        <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† Ù‡Ù†Ø§ -->
      </ul>
    </div>
    <div class="popup-chat-footer">
      <input type="text" id="liveChatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
      <button onclick="sendLiveChatMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>

  <script>
    // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Ùˆ Mapbox
    const firebaseConfig = {
      apiKey: "AIzaSyAzNFMx0l3x-1qSB7zYEHJwasBnkPOfpg0",
      authDomain: "ms-mv-71de8.firebaseapp.com",
      projectId: "ms-mv-71de8",
      storageBucket: "ms-mv-71de8.appspot.com",
      messagingSenderId: "11803494011",
      appId: "1:11803494011:web:313992c0215928cb3b44de",
      measurementId: "G-XKKEK82ZPD"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø±ÙŠØ·Ø© Mapbox
    mapboxgl.accessToken = 'pk.eyJ1IjoiZXNsb3BpIiwiYSI6ImNtMWV6OHI3eDFoeGMybHF6bmR0OXcwbWIifQ.PgBVsl5bPmcOQ_47NDK10A';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [46.6753, 24.7136],
      zoom: 10
    });

    db.collection("places").get().then((querySnapshot) => {
      querySnapshot.forEach((doc) => {
        const place = doc.data();
        addPlaceMarker(place.name, place.description, place.latitude, place.longitude, place.imageUrl);
      });
    });

    function addPlaceMarker(name, description, latitude, longitude, imageUrl) {
      const marker = new mapboxgl.Marker()
        .setLngLat([longitude, latitude])
        .addTo(map);

      marker.getElement().addEventListener('click', function() {
        document.getElementById('place-info').style.display = 'block';
        document.getElementById('place-name').textContent = name;
        document.getElementById('place-description').textContent = description;
        document.getElementById('place-image').src = imageUrl;
        document.getElementById('place-image').alt = name;
        document.getElementById('no-selection').style.display = 'none';
      });
    }

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
    document.getElementById('locateButton').addEventListener('click', function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          map.flyTo({ center: [lon, lat], zoom: 14 });
          new mapboxgl.Marker().setLngLat([lon, lat]).addTo(map);
        }, function() {
          alert('ØºÙŠØ± Ù‚Ø§Ø¯Ø± Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ.');
        });
      } else {
        alert('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ.');
      }
    });

    // ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    function openBotChat() {
      document.getElementById('botChatPopup').style.display = 'flex';
      loadBotChatMessages();
    }

    function closeBotChat() {
      document.getElementById('botChatPopup').style.display = 'none';
    }

    function openLiveChat() {
      document.getElementById('liveChatPopup').style.display = 'flex';
      loadLiveChatMessages();
      loadLiveUsers();
    }

    function closeLiveChat() {
      document.getElementById('liveChatPopup').style.display = 'none';
    }

    // Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    function sendLiveChatMessage() {
      const message = document.getElementById('liveChatInput').value;
      if (message.trim() !== "") {
        db.collection("liveChat").add({
          message: message,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          document.getElementById('liveChatInput').value = "";
        }).catch(error => console.error("Error sending message: ", error));
      }
    }

    function sendBotChatMessage() {
      const message = document.getElementById('botChatInput').value;
      if (message.trim() !== "") {
        db.collection("botChat").add({
          message: message,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          document.getElementById('botChatInput').value = "";
        }).catch(error => console.error("Error sending message: ", error));
      }
    }

    function loadLiveChatMessages() {
      db.collection("liveChat").orderBy("timestamp").onSnapshot(snapshot => {
        const chatMessages = document.getElementById('liveChatMessages');
        chatMessages.innerHTML = "";
        snapshot.forEach(doc => {
          const messageData = doc.data();
          const messageElement = document.createElement('div');
          messageElement.classList.add('message');
          messageElement.innerHTML = `<div class="text-container">${messageData.message}</div>`;
          chatMessages.appendChild(messageElement);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
    }

    function loadBotChatMessages() {
      db.collection("botChat").orderBy("timestamp").onSnapshot(snapshot => {
        const botMessages = document.getElementById('botChatMessages');
        botMessages.innerHTML = "";
        snapshot.forEach(doc => {
          const messageData = doc.data();
          const messageElement = document.createElement('div');
          messageElement.classList.add('message');
          messageElement.innerHTML = `<div class="text-container">${messageData.message}</div>`;
          botMessages.appendChild(messageElement);
        });
        botMessages.scrollTop = botMessages.scrollHeight;
      });
    }

    function loadLiveUsers() {
      db.collection("liveUsers").onSnapshot(snapshot => {
        const liveUserList = document.getElementById('liveUserList');
        liveUserList.innerHTML = "";
        snapshot.forEach(doc => {
          const userData = doc.data();
          const userElement = document.createElement('li');
          userElement.textContent = userData.name;
          liveUserList.appendChild(userElement);
        });
      });
    }
  </script>
</body>
</html>
